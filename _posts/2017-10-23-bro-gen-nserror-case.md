---
layout: post
title: 'bro-gen: binding NSError error codes right'
tags: ['bro-gen', binding]
---
In RoboVM's cocoatouch there are bunch of NSError subclasses that don't exist in objc iOS itself. For example [WKError](https://github.com/MobiVM/robovm/blob/45b1de02cad5d857918d7604414404323c75f715/compiler/cocoatouch/src/main/java/org/robovm/apple/webkit/WKError.java)
This is hand written class required to allow RoboVM's NSError return object error code which can be used to compare against enum members, such as [WKErrorCode](https://github.com/MobiVM/robovm/blob/7cb74213b5d4b036ba01cd63ca9771e1230bd153/compiler/cocoatouch/src/main/java/org/robovm/apple/watchkit/WKErrorCode.java).  
`NSError` provides information by following properties:  
<!-- more -->
```objc
@interface NSError : NSObject <NSCopying, NSSecureCoding>
@property (readonly, copy) NSErrorDomain domain;
@property (readonly) NSInteger code;
@property (readonly, copy) NSDictionary<NSErrorUserInfoKey, id> * userInfo;
```

in RoboVM world `NSError` exposes same methods, but there is another hand written method [getErrorCode](https://github.com/MobiVM/robovm/blob/307093d4776c544e84b3e6bd014b703c914332dc/compiler/cocoatouch/src/main/java/org/robovm/apple/foundation/NSError.java#L147)
and its purpose is to return Object representation for error which can be used to compare agains error codes enums, usually present in binding as well.

***So all this is just to allow using following code:***  
```java
NSError error;
if (error.getErrorCode() == WKErrorCode.MediaPlayer) {
    ....
}
```

instead of:
```java
NSError error;
if (error.getCode() == WKErrorCode.MediaPlayer.value()) {
    ....
}
```

***how it works***  
[getErrorCode](https://github.com/MobiVM/robovm/blob/307093d4776c544e84b3e6bd014b703c914332dc/compiler/cocoatouch/src/main/java/org/robovm/apple/foundation/NSError.java#L147) is confusing as it knows only about values of `NSCocoaErrorCode` enum. The magic is in following places:
1. [static initializer](https://github.com/MobiVM/robovm/blob/307093d4776c544e84b3e6bd014b703c914332dc/compiler/cocoatouch/src/main/java/org/robovm/apple/foundation/NSError.java#L77)
2. [NSError.Marshaller](https://github.com/MobiVM/robovm/blob/307093d4776c544e84b3e6bd014b703c914332dc/compiler/cocoatouch/src/main/java/org/robovm/apple/foundation/NSError.java#L51)

What is happening:  
1. `static initializer` looks over all VM known classes for NSError subclasses and builds the map `allNSErrorClasses` domain to NSError subclass. To get to the party subclass *shall* contain static `getClassDomain` method which is being called to get domain this NSError subclass is responsible for.
2. `marshaller` is responsible to create java side object corresponding to native one. But it first goes native side to get its domain staring and then if `allNSErrorClasses` contains class for domain it creates this virtual NSError subclass instance, e.g. `WKError`
3. now WKError will be able to return proper object in `getErrorCode`


***how it was bound***  
1. `WKErrorCode` was generated by `bro-gen` to enum, then it was manually updated to implement NSErrorCode interface
2. `WKError` was manually written with implementation of `getErrorCode`  to return proper value from `WKErrorCode`;
3. `WKErrorCode` had to be annotated with `@ForceLinkClass(WKError.class)` this forces `WKError` not to be excluded from scope as long as `WKErrorCode` is used.

***how it was reworked in bro-gen to simplify bindings***
1. new enum template `nserror_enum_template` added. it is used for enum as long as in enum specification there is `nserror: true`
2. this template contains `NSErrorWrap` subclass of `NSError` subclass. So no need to manually write NSError subclass
3. `getErrorCode` required to be added enum (which connects NSError with it), usually there is global variable for this, so it has to be bound with enum by `getErrorCode` name.

Check this example:
```yaml
enums:
    GADErrorCode: {nserror: true, prefix: kGADError}
....    
values:
    kGADErrorDomain:
        class: GADErrorCode
        name: getClassDomain
```

Happy bro-gening!  
Related: [Tutorial: [ADMOB] using bro-gen to quick generate bindings]({{ site.baseurl }}{% post_url 2017-10-19-bro-gen-tutorial %})
